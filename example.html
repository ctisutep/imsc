<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>Texas' Stickiness</title>
    <link rel="stylesheet" href="//js.arcgis.com/3.17/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="//js.arcgis.com/3.17/esri/css/esri.css">
<!--    <link rel="stylesheet" href="./css/styles.css" /> -->
  </head>
  <body class="claro">
    <div id="esri-map-container"></div>
    <div id="esri-basemapgallery-container" class="esriBasemapGallery"></div>
    <div id="esri-colorinfoslider-container">
      <div id="title"></div>
      <hr>
      <div>
        District:
        <select id="District">
          <option value="Abilene" selected>Abilene</option>
          <option value="Amarillo">Amarillo</option>
          <option value="Atlanta">Atlanta</option>
          <option value="Austin">Austin</option>
          <option value="Beaumont">Beaumont</option>
          <option value="Brownwood">Brownwood</option>
          <option value="Bryan">Bryan</option>
          <option value="Childress">Childress</option>
          <option value="CorpusChristi">Corpus Christi</option>
          <option value="Dallas">Dallas</option>
          <option value="ElPaso">El Paso</option>
          <option value="FortWorth">Fort Worth</option>
          <option value="Houston">Houston</option>
          <option value="Laredo">Laredo</option>
          <option value="Lubbock">Lubbock</option>
          <option value="Lufkin">Lufkin</option>
          <option value="Odessa">Odessa</option>
          <option value="Paris">Paris</option>
          <option value="Pharr">Pharr</option>
          <option value="SanAngelo">San Angelo</option>
          <option value="SanAntonio">San Antonio</option>
          <option value="Tyler">Tyler</option>
          <option value="Waco">Waco</option>
          <option value="WichitaFalls">Wichita Falls</option>
          <option value="Yoakum">Yoakum</option>
        </select>
      </div>
      <div>
      	<label for="fieldNames">Render based on: </label>
            <select id="fieldNames" name="baseSym"
                    data-dojo-type="dijit/form/FilteringSelect"
                    data-dojo-props="style:'width:200px;'">
            </select>
            <img id="loading" src="https://dl.dropboxusercontent.com/u/2142726/esrijs-samples/loading_black.gif" />
      </div>
      <div id="legendDiv"></div>
      <input type="checkbox" id="sliderZoomButton"/> Show histogram detail
    </div>
  </body>
  <script src="//js.arcgis.com/3.17/"></script>
  <script src="js/districts.js"></script>
  <script>
    require([
      "dojo/_base/array",
      "dojo/dom",
      "dojo/dom-style",
      "dojo/number",
      "dojo/on",
      "dojo/parser",
      "esri/basemaps",
      "esri/Color",
      "esri/dijit/Basemap",
      "esri/dijit/BasemapGallery",
      "esri/dijit/PopupTemplate",
      "esri/dijit/Legend",
      "esri/dijit/util/busyIndicator",
      "esri/InfoTemplate",
      "esri/layers/FeatureLayer",
      "esri/map",
      "esri/plugins/FeatureLayerStatistics",
      "esri/request",
      "esri/renderers/smartMapping",
      "esri/renderers/UniqueValueRenderer",
      "esri/symbols/SimpleFillSymbol",
      "esri/symbols/SimpleLineSymbol",
      "dijit/registry",
      "dojo/data/ItemFileReadStore",
      "dijit/form/FilteringSelect",
      "dojo/domReady!"
    ], function (
      arrayUtils, dom, domStyle, number, on,
      parser, esriBasemaps, Color, Basemap, BasemapGallery, PopupTemplate, Legend, busyIndicator,
      InfoTemplate, FeatureLayer, Map, FeatureLayerStatistics, esriRequest, smartMapping, UniqueValueRenderer,
      SimpleFillSymbol, SimpleLineSymbol, registry, ItemFileReadStore
    ){
      parser.parse();

      var basemap = "gray";
      var district = "ElPaso";
      var theme = "high-to-low";
      //var fieldName= "SPATIALVER";Shape_Length,Shape_Area,hzdept_r,hzdepb_r,frag3to10_r,sieveno4_r,sieveno40_r,sieveno10_r,sieveno200_r,sandtotal_r,sandvc_r,sandco_r,aashind_r
      var fieldName = "frag3to10_r";

      var perUrl = "http://irpsrvgis37.utep.edu/arcgis/rest/services/Texas/Perimeters_joined/MapServer/0";
      var url = "http://irpsrvgis34.utep.edu/arcgis/rest/services/Texas/Stickiness_state/MapServer/0";
      var mapOptions = {basemap: basemap, center: [-99, 31.31], zoom: 6, level: 9};
      var map = new Map("esri-map-container", mapOptions);

      var fieldsAlias;
      var requestHandle = esriRequest({
        "url": url,
        "content": {
          "f": "json"
        },
        "callbackParamName": "callback"
      });
      requestHandle.then(requestSucceeded);
    

    function requestSucceeded(response, io){
      var fieldInfo, pad;
      pad = dojoString.pad;

      //toJson converts the given JavaScript object
      //and its properties and values into simple text 
      dojoJson.toJsonIndentStr = "  ";
      console.log("response as text:\n", dojoJson.toJson(response,true));
      dom.byId("status").innerHTML = "";

      //show field names and aliases
      if ( response.hasOwnProperty("fields") ) {
        console.log("got some fields");
        fieldInfo = array.map(response.fields, function(f) {
          return pad("Field:", 8, " ", true) + pad(f.name, 25, " ", true) + 
            pad("Alias:", 8, " ", true) + pad(f.alias, 25, " ", true);
        });
        fieldsAlias = fieldInfo.join("\n");
      }
    }; 

      var popupTemplate = new PopupTemplate({
        title: "Property: " + fieldName,
        description: "Corrosion Concrete: {corcon}<br>" + "Corrosion Steel: {corsteel}<br>"
        + "Top Depth: {hzdept_r}<br>" + "Bottom Depth: {hzdepb_r}<br>"
        + "Rock 3-10: {frag3to10_r}<br>" + "Sieve #4: {sieveno4_r}<br>"
        + "Sieve #10: {sieveno10_r}<br>" + "Sieve #40: {sieveno40_r}<br>"
        + "Sieve #200: {sieveno200_r}<br>" + "Total Sand: {sandtotal_r}<br>"
        + "Very Course Sand: {sandvc_r}<br>" + "Course Sand: {sandco_r}<br>"
        + "Medium Sand: {sandmed_r}<br>" + "Fine Sand: {sandfine_r}<br>"
        + "Very Fine Sand: {sandvf_r}<br>" + "Total Silt: {silttotal_r}<br>"
        + "Coarse Silt: {siltco_r}<br>" + " Fine Silt: {siltfine_r}<br>"
        + "Total Clay: {claytotal_r}<br>" + "CaCO3 Clay: {claysizedcarb_r}<br>"
        + "OM: {om_r}<br>" + "Dp: {partdensity}<br>"
        + "Ksat: {ksat_r}<br>" + "LL: {ll_r}<br>"
        + "PI: {pi_r}<br>" + "AASHTO Group Index: {aashind_r}<br>"
        + "K-Factor Whole Soil: {kwfact}<br>" + "K-Factor Rock Free: {kffact}<br>"
        + "CaCO3: {caco3_r}<br>" + "Gypsum: {gypsum_r}<br>"
        + "SAR: {sar_r}<br>" + " pH H2O: {ph1to1h2o_r}<br>"
        + " pH CaCl2: {ph01mcacl2_r}<br>" + "Excav Diff: {excavdifcl}<br>"
        + "Rupture Moist: {rupresblkmst}<br>" + "Rupture Dry: {rupresblkdry}<br>"
        + "Rupture Cement: {rupresblkcem}<br>" + "Rupture Plate: {rupresplate}<br>"
        + "Manner of Failure: {mannerfailure}<br>" + "stickiness: {stickiness}<br>"
        + "plasticity: {plasticity}<br>"
      });
      var perimeter = new FeatureLayer (perUrl, {outFields: ["*"]});
      var featureLayer = new FeatureLayer(url, {
      	id: "soil",
        outFields: ["*"],
        infoTemplate: popupTemplate});
      var featureLayerStatistics = new FeatureLayerStatistics({layer: featureLayer, visible: false});
      
      featureLayer.setDefinitionExpression(SanAngelo + " AND hzdept_r < 30 AND hzdepb_r < 30");
      
      map.addLayer(perimeter);
      map.addLayer(featureLayer);
      
      	// get field info
		var countyFields = esriRequest({
		  url: url,
		  content: {
		    f: "json"
		  },
		  callbackParamName: "callback"
		});
		countyFields.then(function(resp) {
		  var fieldNames, fieldStore;
		
		  fieldNames = { identifier: "value", label: "name", items: [] };
		  arrayUtils.forEach(resp.fields.slice(8, 58), function(f) { // add some field names to the FS
		    fieldNames.items.push({ "name": f.alias, "value": f.name, "type": f.type });
		  });
		  fieldStore = new ItemFileReadStore({ data: fieldNames });
		  registry.byId("fieldNames").set("store", fieldStore);
		  registry.byId("fieldNames").set("value", "frag3to10_r"); // set a value
		}, function(err) {
		  console.log("failed to get field names: ", err);
		});

		// hide the loading icon when the counties layer finishes updating
        featureLayer.on("update-end", function() {
          domStyle.set("loading", "visibility", "hidden");
        });
	    
      smartMapping.createColorRenderer({
        layer: featureLayer,
        field: fieldName,
        showOthers: false,
        basemap: basemap,
        theme: theme
        }).then(function (colorRenderer){
        //console.log("create color renderer is generated", colorRenderer);

        if (!featureLayer.visible) {
          featureLayer.show();
        }
        featureLayer.setRenderer(colorRenderer.renderer);
        featureLayer.redraw();
      });

        dom.byId("District").onchange = function(){
          featureLayer.setDefinitionExpression(SanAngelo + " AND hzdept_r < 30 AND hzdepb_r < 30");
        }

      dom.byId("sliderZoomButton").onchange = function(){
      	fieldName = "plasticity";
      	smartMapping.createColorRenderer({
	        layer: featureLayer,
	        field: fieldName,
	        showOthers: false,
	        basemap: basemap,
	        theme: theme
	        }).then(function (colorRenderer){
	        //console.log("create color renderer is generated", colorRenderer);
	
	        if (!featureLayer.visible) {
	          featureLayer.show();
	        }
	        featureLayer.setRenderer(colorRenderer.renderer);
	        featureLayer.redraw();
	      });
      };
	  	registry.byId("fieldNames").on("change", getData);
	    registry.byId("fieldNames").set("value", "frag3to10_r"); // triggers getData()
	    var legend = "";
	    function getData(){
	    	domStyle.set("loading", "visibility", "visible");
	    	var fieldName = registry.byId("fieldNames").get("value") || "frag3to10_r";
	    	if(registry.byId("fieldNames").item.type[0] == "esriFieldTypeString"){//check if it is numeric
	    		//case where not numeric, use uniquerender
	    		//create symbol for renderer
	    		var defaultSymbol = new SimpleFillSymbol().setStyle(SimpleFillSymbol.STYLE_NULL);
          		defaultSymbol.outline.setStyle(SimpleLineSymbol.STYLE_NULL);
	    		//create renderer
          		var renderer = new UniqueValueRenderer(defaultSymbol, fieldName);
          		renderer.addValue("Very plastic", new SimpleFillSymbol().setColor(new Color([255, 255, 0, 0.5])));
          		featureLayer.setRenderer(renderer);
          		featureLayer.redraw();
          		if(typeof legend == "string"){
		        	legend = new Legend({
		            map : map,
		            layerInfos : [ {
		              layer : map.getLayer("soil"),
		              hideLayers: [0],
		              title : "Values"
		            } ]
		          }, dom.byId("legendDiv"));
		          legend.defaultSymbol = false;
		          legend.startup();
		        }
		        else{
		        	legend.refresh([{layer:map.getLayer("soil")}]);
		        }
	    	}
	    	else{//case where numeric, use smartmapping
	    		smartMapping.createColorRenderer({
		        layer: featureLayer,
		        field: fieldName,
		        showOthers: false,
		        basemap: basemap,
		        theme: theme
		        }).then(function (colorRenderer){
		        //console.log("create color renderer is generated", colorRenderer);
		
		        if (!featureLayer.visible) {
		          featureLayer.show();
		        }
		        featureLayer.setRenderer(colorRenderer.renderer);
		        featureLayer.redraw();
		        if(typeof legend == "string"){
		        	legend = new Legend({
		            map : map,
		            layerInfos : [ {
		              layer : map.getLayer("soil"),
		              hideLayers: [0],
		              title : "Values"
		            } ]
		          }, dom.byId("legendDiv"));
		          legend.defaultSymbol = false;
		          legend.startup();
		        }
		        else{
		        	legend.refresh([{layer:map.getLayer("soil")}]);
		        }
		        domStyle.set("loading", "visibility", "hidden");
		      });
	    	}
	    }


    });
  </script>
</html>
